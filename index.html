<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aprende a Leer - Versi√≥n Mejorada</title>
    
    <!-- 1. Estilos Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'kid-blue': '#4CC9F0',
              'kid-pink': '#F72585',
              'kid-yellow': '#FFD60A',
              'kid-green': '#06D6A0',
              'kid-purple': '#7209B7',
              'kid-orange': '#FB5607',
            },
            fontFamily: {
              sans: ['Comic Sans MS', 'Comic Sans', 'cursive', 'sans-serif'],
            },
            animation: {
              'bounce-slow': 'bounce 3s infinite',
            }
          }
        }
      }
    </script>

    <!-- 2. Librer√≠as React (Versiones UMD Universales) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Google Gemini SDK -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
    <script type="module">
      import { GoogleGenAI } from "@google/genai";
      window.GoogleGenAI = GoogleGenAI;
    </script>

    <style>
      body { background-color: #f0fdfa; user-select: none; }
      .btn-press:active { transform: scale(0.95); }
      /* Estilo para el slider */
      input[type=range] {
        height: 34px;
        -webkit-appearance: none;
        margin: 10px 0;
        width: 100%;
        background: transparent;
      }
      input[type=range]:focus { outline: none; }
      input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 12px;
        cursor: pointer;
        background: #E5E7EB;
        border-radius: 25px;
      }
      input[type=range]::-webkit-slider-thumb {
        height: 28px;
        width: 28px;
        border-radius: 50%;
        background: #F72585;
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <!-- 5. L√ìGICA DE LA APLICACI√ìN -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- DATOS Y CONSTANTES ---
        const API_KEY = ""; // PON TU API KEY AQU√ç

        const ModelType = {
          SYLLABIC: 'silabico',
          FLUENCY: 'fluidez'
        };

        const IMG_BASE = "https://picsum.photos/seed";
        
        const LEVELS = [
          {
            id: 'level-1',
            title: 'Nivel 1: Las Vocales',
            description: 'Aprende las vocales con im√°genes.',
            color: 'bg-kid-blue',
            items: [
              { id: 'l1-1', type: 'vowel', text: 'a', image: `${IMG_BASE}/airplane/300/300`, syllables: ['a'] },
              { id: 'l1-2', type: 'vowel', text: 'e', image: `${IMG_BASE}/elephant/300/300`, syllables: ['e'] },
              { id: 'l1-3', type: 'vowel', text: 'i', image: `${IMG_BASE}/church/300/300`, syllables: ['i'] },
              { id: 'l1-4', type: 'vowel', text: 'o', image: `${IMG_BASE}/bear/300/300`, syllables: ['o'] },
              { id: 'l1-5', type: 'vowel', text: 'u', image: `${IMG_BASE}/grapes/300/300`, syllables: ['u'] },
            ]
          },
          {
            id: 'level-2',
            title: 'Nivel 2: S√≠labas (M)',
            description: 'Palabras con Ma, Me, Mi, Mo, Mu.',
            color: 'bg-kid-pink',
            items: [
              { id: 'l2-1', type: 'word', text: 'mam√°', syllables: ['ma', 'm√°'], image: `${IMG_BASE}/mom/300/300` },
              { id: 'l2-2', type: 'word', text: 'ama', syllables: ['a', 'ma'] },
              { id: 'l2-3', type: 'word', text: 'mami', syllables: ['ma', 'mi'] },
              { id: 'l2-4', type: 'word', text: 'amo', syllables: ['a', 'mo'] },
              { id: 'l2-5', type: 'word', text: 'mima', syllables: ['mi', 'ma'] },
              { id: 'l2-6', type: 'word', text: 'eme', syllables: ['e', 'me'] },
              { id: 'l2-7', type: 'word', text: 'memo', syllables: ['me', 'mo'] },
              { id: 'l2-8', type: 'word', text: 'mimo', syllables: ['mi', 'mo'] },
              { id: 'l2-9', type: 'word', text: 'm√≠o', syllables: ['m√≠', 'o'] },
              { id: 'l2-10', type: 'word', text: 'ame', syllables: ['a', 'me'] },
              { id: 'l2-11', type: 'word', text: 'm√≠a', syllables: ['m√≠', 'a'] },
              { id: 'l2-12', type: 'word', text: 'miau', syllables: ['miau'] },
            ]
          },
          {
            id: 'level-3',
            title: 'Nivel 3: Frases (M)',
            description: 'Leyendo oraciones con M.',
            color: 'bg-kid-green',
            items: [
              { 
                id: 'l3-1', 
                type: 'sentence', 
                text: 'amo a mi mam√°', 
                words: ['amo', 'a', 'mi', 'mam√°'],
                syllables: ['a', 'mo', ' ', 'a', ' ', 'mi', ' ', 'ma', 'm√°'],
                image: `${IMG_BASE}/lovemom/400/200` 
              },
              { 
                id: 'l3-2', 
                type: 'sentence', 
                text: 'mi mam√° me ama', 
                words: ['mi', 'mam√°', 'me', 'ama'],
                syllables: ['mi', ' ', 'ma', 'm√°', ' ', 'me', ' ', 'a', 'ma']
              },
              { 
                id: 'l3-3', 
                type: 'sentence', 
                text: 'mimo a mi mam√°', 
                words: ['mimo', 'a', 'mi', 'mam√°'],
                syllables: ['mi', 'mo', ' ', 'a', ' ', 'mi', ' ', 'ma', 'm√°']
              },
              { 
                id: 'l3-4', 
                type: 'sentence', 
                text: 'mi mam√° me mima', 
                words: ['mi', 'mam√°', 'me', 'mima'],
                syllables: ['mi', ' ', 'ma', 'm√°', ' ', 'me', ' ', 'mi', 'ma']
              },
            ]
          },
          {
            id: 'level-4',
            title: 'Nivel 4: S√≠labas (P)',
            description: 'Palabras con Pa, Pe, Pi, Po, Pu.',
            color: 'bg-kid-purple',
            items: [
              { id: 'l4-s1', type: 'word', text: 'pa', syllables: ['pa'], image: `${IMG_BASE}/father/300/300` },
              { id: 'l4-s2', type: 'word', text: 'pe', syllables: ['pe'], image: `${IMG_BASE}/ball/300/300` },
              { id: 'l4-s3', type: 'word', text: 'pi', syllables: ['pi'], image: `${IMG_BASE}/pineapple/300/300` },
              { id: 'l4-s4', type: 'word', text: 'po', syllables: ['po'], image: `${IMG_BASE}/chick/300/300` },
              { id: 'l4-s5', type: 'word', text: 'pu', syllables: ['pu'], image: `${IMG_BASE}/fist/300/300` },
              { id: 'l4-1', type: 'word', text: 'pap√°', syllables: ['pa', 'p√°'] },
              { id: 'l4-2', type: 'word', text: 'mopa', syllables: ['mo', 'pa'] },
              { id: 'l4-3', type: 'word', text: 'popa', syllables: ['po', 'pa'] },
              { id: 'l4-4', type: 'word', text: 'papi', syllables: ['pa', 'pi'] },
              { id: 'l4-5', type: 'word', text: 'pepe', syllables: ['pe', 'pe'] },
              { id: 'l4-6', type: 'word', text: 'pipa', syllables: ['pi', 'pa'] },
              { id: 'l4-7', type: 'word', text: 'pepa', syllables: ['pe', 'pa'] },
              { id: 'l4-8', type: 'word', text: 'mapa', syllables: ['ma', 'pa'] },
              { id: 'l4-9', type: 'word', text: 'p√∫a', syllables: ['p√∫', 'a'] },
              { id: 'l4-10', type: 'word', text: 'p√≠o', syllables: ['p√≠', 'o'] },
              { id: 'l4-11', type: 'word', text: 'p√≠a', syllables: ['p√≠', 'a'] },
              { id: 'l4-12', type: 'word', text: 'puma', syllables: ['pu', 'ma'] },
            ]
          },
          {
            id: 'level-5',
            title: 'Nivel 5: S√≠labas (L)',
            description: 'Palabras con La, Le, Li, Lo, Lu.',
            color: 'bg-kid-orange',
            items: [
              // S√≠labas con im√°genes
              { id: 'l5-s1', type: 'word', text: 'la', syllables: ['la'], image: `${IMG_BASE}/pencil/300/300` },
              { id: 'l5-s2', type: 'word', text: 'le', syllables: ['le'], image: `${IMG_BASE}/milk/300/300` },
              { id: 'l5-s3', type: 'word', text: 'li', syllables: ['li'], image: `${IMG_BASE}/lemon/300/300` },
              { id: 'l5-s4', type: 'word', text: 'lo', syllables: ['lo'], image: `${IMG_BASE}/wolf/300/300` },
              { id: 'l5-s5', type: 'word', text: 'lu', syllables: ['lu'], image: `${IMG_BASE}/moon/300/300` },
              
              // Palabras del texto
              { id: 'l5-1', type: 'word', text: 'loma', syllables: ['lo', 'ma'] },
              { id: 'l5-2', type: 'word', text: 'lima', syllables: ['li', 'ma'] },
              { id: 'l5-3', type: 'word', text: 'lame', syllables: ['la', 'me'] },
              { id: 'l5-4', type: 'word', text: 'lomo', syllables: ['lo', 'mo'] },
              
              { id: 'l5-5', type: 'word', text: 'malo', syllables: ['ma', 'lo'] },
              { id: 'l5-6', type: 'word', text: 'mula', syllables: ['mu', 'la'] },
              { id: 'l5-7', type: 'word', text: 'pelo', syllables: ['pe', 'lo'] },
              { id: 'l5-8', type: 'word', text: 'pila', syllables: ['pi', 'la'] },
              
              { id: 'l5-9', type: 'word', text: 'paloma', syllables: ['pa', 'lo', 'ma'] },
              { id: 'l5-10', type: 'word', text: 'pomelo', syllables: ['po', 'me', 'lo'] },

              { id: 'l5-11', type: 'word', text: 'lola', syllables: ['lo', 'la'] },
              { id: 'l5-12', type: 'word', text: 'lalo', syllables: ['la', 'lo'] },
              
              // Frase
              { 
                id: 'l5-13', 
                type: 'sentence', 
                text: 'lola asea la sala', 
                words: ['lola', 'asea', 'la', 'sala'],
                syllables: ['lo', 'la', ' ', 'a', 'se', 'a', ' ', 'la', ' ', 'sa', 'la']
              }
            ]
          },
          {
            id: 'level-6',
            title: 'Nivel 6: Frases (P)',
            description: 'Oraciones con Pap√° y Mam√°.',
            color: 'bg-kid-pink',
            items: [
              { 
                id: 'l6-1', 
                type: 'sentence', 
                text: 'pap√° ama a mam√°', 
                words: ['pap√°', 'ama', 'a', 'mam√°'],
                syllables: ['pa', 'p√°', ' ', 'a', 'ma', ' ', 'a', ' ', 'ma', 'm√°'],
                image: `${IMG_BASE}/parents/400/250`
              },
              { 
                id: 'l6-2', 
                type: 'sentence', 
                text: 'mam√° ama a papi', 
                words: ['mam√°', 'ama', 'a', 'papi'],
                syllables: ['ma', 'm√°', ' ', 'a', 'ma', ' ', 'a', ' ', 'pa', 'pi']
              },
              { 
                id: 'l6-3', 
                type: 'sentence', 
                text: 'mi pap√° me ama', 
                words: ['mi', 'pap√°', 'me', 'ama'],
                syllables: ['mi', ' ', 'pa', 'p√°', ' ', 'me', ' ', 'a', 'ma']
              },
              { 
                id: 'l6-4', 
                type: 'sentence', 
                text: 'amo a mi pap√°', 
                words: ['amo', 'a', 'mi', 'pap√°'],
                syllables: ['a', 'mo', ' ', 'a', ' ', 'mi', ' ', 'pa', 'p√°']
              }
            ]
          },
          {
            id: 'level-7',
            title: 'Nivel 7: Repaso (L)',
            description: 'M√°s pr√°ctica: loma, palo, ala...',
            color: 'bg-kid-yellow',
            items: [
              { id: 'l7-1', type: 'word', text: 'loma', syllables: ['lo', 'ma'], image: `${IMG_BASE}/hill/300/300` },
              { id: 'l7-2', type: 'word', text: 'palo', syllables: ['pa', 'lo'], image: `${IMG_BASE}/stick/300/300` },
              { id: 'l7-3', type: 'word', text: 'ala', syllables: ['a', 'la'], image: `${IMG_BASE}/wing/300/300` },
              { id: 'l7-4', type: 'word', text: 'pala', syllables: ['pa', 'la'], image: `${IMG_BASE}/shovel/300/300` },
              { id: 'l7-5', type: 'word', text: 'lima', syllables: ['li', 'ma'], image: `${IMG_BASE}/lime/300/300` },
              { id: 'l7-6', type: 'word', text: 'pila', syllables: ['pi', 'la'], image: `${IMG_BASE}/battery/300/300` },
              { id: 'l7-7', type: 'word', text: 'lee', syllables: ['le', 'e'], image: `${IMG_BASE}/reading/300/300` },
              { id: 'l7-8', type: 'word', text: 'paloma', syllables: ['pa', 'lo', 'ma'], image: `${IMG_BASE}/pigeon/300/300` },
              { id: 'l7-9', type: 'word', text: 'lomo', syllables: ['lo', 'mo'], image: `${IMG_BASE}/meat/300/300` },
              { id: 'l7-10', type: 'word', text: 'lupa', syllables: ['lu', 'pa'], image: `${IMG_BASE}/magnifying/300/300` },
              { id: 'l7-11', type: 'word', text: 'mula', syllables: ['mu', 'la'], image: `${IMG_BASE}/mule/300/300` },
              { id: 'l7-12', type: 'word', text: 'lame', syllables: ['la', 'me'], image: `${IMG_BASE}/dog/300/300` },
            ]
          }
        ];

        // --- SERVICIO IA ---
        function blobToBase64(blob) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        }

        async function getTeacherFeedback(audioBlob, textRead) {
          if (!API_KEY || !window.GoogleGenAI) {
            return "¬°Lo hiciste genial! Sigue practicando as√≠ de bien.";
          }
          try {
            const ai = new window.GoogleGenAI({ apiKey: API_KEY });
            const base64Audio = await blobToBase64(audioBlob);
            const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: {
                parts: [
                  { text: `Escucha este audio de un ni√±o leyendo: "${textRead}". Responde en espa√±ol, muy breve (10 palabras max), felic√≠talo con entusiasmo.` },
                  { inlineData: { mimeType: audioBlob.type || 'audio/webm', data: base64Audio } }
                ]
              }
            });
            return response.text || "¬°Muy bien!";
          } catch (error) {
            console.error("Error IA:", error);
            return "¬°Eres un campe√≥n! ¬°Sigue leyendo!";
          }
        }

        // --- COMPONENTE: LECCI√ìN ACTIVA ---
        const ActiveLesson = ({ levelId, model, onBack }) => {
          const level = LEVELS.find(l => l.id === levelId);
          const items = level ? level.items : [];
          
          const [currentIndex, setCurrentIndex] = useState(0);
          const [isReading, setIsReading] = useState(false);
          
          const [highlightIndex, setHighlightIndex] = useState(-1);
          const [highlightType, setHighlightType] = useState(null); // 'SYLLABLE', 'WORD', 'FULL', null
          
          const [audioBlob, setAudioBlob] = useState(null);
          const [feedback, setFeedback] = useState(null);
          const [loadingFeedback, setLoadingFeedback] = useState(false);
          const [finished, setFinished] = useState(false);
          const [waitingForNext, setWaitingForNext] = useState(false);
          const [micError, setMicError] = useState(false);
          const [playbackRate, setPlaybackRate] = useState(1);

          const mediaRecorderRef = useRef(null);
          const chunksRef = useRef([]);
          const synthRef = useRef(window.speechSynthesis);
          const sequenceIdRef = useRef(0);

          const currentItem = items[currentIndex];

          useEffect(() => { return () => synthRef.current.cancel(); }, []);

          const startSession = async () => {
            if(isReading) return;
            setIsReading(true);
            setFinished(false);
            setFeedback(null);
            setAudioBlob(null);
            setMicError(false);
            setCurrentIndex(0);
            chunksRef.current = [];

            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              const recorder = new MediaRecorder(stream);
              mediaRecorderRef.current = recorder;
              recorder.ondataavailable = (e) => {
                if(e.data.size > 0) chunksRef.current.push(e.data);
              };
              recorder.onstop = () => {
                const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                setAudioBlob(blob);
                stream.getTracks().forEach(t => t.stop());
              };
              recorder.start();
            } catch (err) {
              setMicError(true);
            }
          };

          const handleNext = () => {
            synthRef.current.cancel();
            setWaitingForNext(false);
            setHighlightIndex(-1);
            setHighlightType(null);
            
            if (currentIndex < items.length - 1) {
              setCurrentIndex(prev => prev + 1);
            } else {
              finishSession();
            }
          };

          const handlePrev = () => {
            synthRef.current.cancel();
            setWaitingForNext(false);
            setHighlightIndex(-1);
            setHighlightType(null);
            if (currentIndex > 0) setCurrentIndex(prev => prev - 1);
          };

          const finishSession = () => {
            setIsReading(false);
            setFinished(true);
            setWaitingForNext(false);
            synthRef.current.cancel();
            if(mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
              mediaRecorderRef.current.stop();
            }
          };

          // --- LOGICA DE LECTURA (KARAOKE MEJORADO) ---
          const runSequence = useCallback(async () => {
            if (!currentItem) return;
            setWaitingForNext(false);
            sequenceIdRef.current++;
            const myId = sequenceIdRef.current;

            const speak = (txt, rate) => new Promise(resolve => {
              if (myId !== sequenceIdRef.current) return resolve();
              const u = new SpeechSynthesisUtterance(txt);
              u.lang = 'es-ES';
              u.rate = rate; 
              u.onend = resolve;
              u.onerror = resolve;
              synthRef.current.speak(u);
            });

            const wait = ms => new Promise(r => setTimeout(r, ms));

            await wait(500);
            if (myId !== sequenceIdRef.current) return;

            // --- MODO 1: SIL√ÅBICO (Para TODOS los niveles si tienen s√≠labas definidas) ---
            if (model === ModelType.SYLLABIC) {
                // Prioridad a la propiedad 'syllables' (Niveles 1, 2, 3 y 4 ahora la tienen)
                if (currentItem.syllables) {
                   for (let i = 0; i < currentItem.syllables.length; i++) {
                      if (myId !== sequenceIdRef.current) return;
                      const syl = currentItem.syllables[i];
                      
                      // Si es un espacio, es una pausa entre palabras
                      if (syl === ' ') {
                          await wait(250); 
                          continue;
                      }

                      setHighlightIndex(i);
                      setHighlightType('SYLLABLE');
                      await speak(syl, 0.6); // Velocidad lenta para s√≠labas
                      await wait(150);
                   }
                   
                   // Al terminar las s√≠labas, lee la palabra/frase completa
                   if (myId !== sequenceIdRef.current) return;
                   setHighlightIndex(-1);
                   setHighlightType('FULL');
                   await speak(currentItem.text, 0.9);
                } 
                else {
                   // Fallback por si acaso
                   setHighlightType('FULL');
                   await speak(currentItem.text, 0.9);
                }
            }

            // --- MODO 2: FLUIDEZ ---
            else if (model === ModelType.FLUENCY) {
                // Si es una frase, resalta palabra por palabra
                if (currentItem.words) {
                    for (let i = 0; i < currentItem.words.length; i++) {
                        if (myId !== sequenceIdRef.current) return;
                        setHighlightIndex(i);
                        setHighlightType('WORD');
                        await speak(currentItem.words[i], playbackRate);
                        await wait(20); 
                    }
                }
                // Si es palabra suelta
                else {
                    setHighlightType('FULL');
                    await speak(currentItem.text, playbackRate);
                }
            }

            if (myId !== sequenceIdRef.current) return;
            setHighlightIndex(-1);
            setHighlightType(null); // Quitar resaltado al esperar
            setWaitingForNext(true); // Habilitar bot√≥n siguiente

          }, [currentItem, model, currentIndex, playbackRate]);

          // Trigger
          useEffect(() => {
            if (isReading && !finished) {
              runSequence();
            }
          }, [currentIndex, isReading, finished, runSequence]);

          const pedirFeedback = async () => {
            if(!audioBlob) return;
            setLoadingFeedback(true);
            const textoLeido = items.map(i => i.text).join(", ");
            const resp = await getTeacherFeedback(audioBlob, textoLeido);
            setFeedback(resp);
            setLoadingFeedback(false);
            const u = new SpeechSynthesisUtterance(resp);
            u.lang = 'es-ES';
            synthRef.current.speak(u);
          };

          const renderText = () => {
            if (!currentItem) return null;

            // MODO SIL√ÅBICO (con Array de s√≠labas)
            if (model === ModelType.SYLLABIC && currentItem.syllables) {
              return (
                <div className="flex flex-wrap justify-center items-end gap-1 md:gap-2">
                  {currentItem.syllables.map((s, i) => {
                    // Renderizar espacio visual si la s√≠laba es ' '
                    if (s === ' ') {
                        return <div key={i} className="w-8 md:w-12 h-16 inline-block"></div>;
                    }

                    const isActive = (highlightType === 'SYLLABLE' && highlightIndex === i) || 
                                     (highlightType === 'FULL');
                    
                    return (
                      <span key={i} className={`text-6xl md:text-8xl font-bold transition-all duration-300 px-1 rounded-lg 
                        ${isActive ? 'text-kid-pink scale-110 bg-pink-100 shadow-lg' : 'text-gray-700'}`}>
                        {s}
                      </span>
                    );
                  })}
                </div>
              );
            }
            
            // MODO FLUIDEZ (con Array de palabras)
            if (currentItem.words) {
               return (
                <div className="flex flex-wrap justify-center gap-3">
                  {currentItem.words.map((w, i) => {
                    const isActive = (highlightType === 'WORD' && highlightIndex === i) || 
                                     (highlightType === 'FULL');

                    return (
                      <span key={i} className={`text-4xl md:text-6xl font-bold transition-all duration-200 px-2 rounded-lg
                        ${isActive ? 'text-kid-purple bg-purple-100 scale-110 shadow-lg' : 'text-gray-700'}`}>
                        {w}
                      </span>
                    );
                  })}
                </div>
               );
            }

            // MODO SIMPLE (Solo texto)
            return (
               <h2 className={`text-6xl md:text-8xl font-bold transition-all duration-300 
                  ${highlightType === 'FULL' ? 'text-kid-purple scale-110' : 'text-gray-700'}`}>
                  {currentItem.text}
               </h2>
            );
          };

          const isLast = currentIndex === items.length - 1;

          return (
            <div className="flex flex-col h-full max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden relative border-4 border-white">
              
              {/* Barra superior */}
              <div className={`p-4 flex flex-col md:flex-row items-center justify-between text-white ${level.color} gap-4`}>
                <div className="flex items-center gap-4 w-full md:w-auto">
                   <button onClick={onBack} className="bg-white/20 hover:bg-white/40 px-4 py-2 rounded-full font-bold btn-press">
                     üè† Salir
                   </button>
                   <span className="text-xl font-bold uppercase tracking-wider hidden md:block">{model === ModelType.SYLLABIC ? 'üê¢ Sil√°bico' : 'üêá Fluidez'}</span>
                </div>

                {/* SLIDER DE VELOCIDAD (SOLO FLUIDEZ) */}
                {model === ModelType.FLUENCY && (
                   <div className="flex items-center gap-2 bg-white/20 p-2 rounded-xl w-full md:w-64">
                      <span className="text-2xl">üê¢</span>
                      <input 
                        type="range" 
                        min="0.5" 
                        max="1.5" 
                        step="0.1" 
                        value={playbackRate} 
                        onChange={(e) => setPlaybackRate(parseFloat(e.target.value))}
                        title="Velocidad de lectura"
                      />
                      <span className="text-2xl">üêá</span>
                   </div>
                )}
              </div>

              {/* √Årea principal */}
              <div className="flex-1 relative flex flex-col items-center justify-center p-4 bg-slate-50">
                
                {/* Progreso */}
                <div className="absolute top-0 left-0 h-2 bg-gray-200 w-full">
                  <div className="h-full bg-kid-green transition-all duration-500" style={{ width: `${((currentIndex + 1) / items.length) * 100}%` }}></div>
                </div>

                {/* Botones Flotantes de Navegaci√≥n */}
                <div className="w-full flex justify-between items-center absolute px-2 md:px-8 top-1/2 -translate-y-1/2 z-0 pointer-events-none">
                   <button onClick={handlePrev} disabled={currentIndex === 0} 
                      className={`pointer-events-auto w-16 h-16 rounded-full bg-white shadow-xl flex items-center justify-center text-3xl hover:bg-blue-50 transition-all ${currentIndex===0 ? 'opacity-0' : 'opacity-100'}`}>
                      üëà
                   </button>
                   
                   {/* Bot√≥n Siguiente (Flecha) */}
                   <button onClick={handleNext} 
                      /* Habilitado si NO estamos leyendo, O si estamos leyendo pero esperando confirmaci√≥n */
                      disabled={isReading && !waitingForNext}
                      className={`pointer-events-auto w-20 h-20 rounded-full shadow-2xl flex items-center justify-center text-4xl transition-all border-4 
                      ${waitingForNext 
                         ? 'bg-kid-green text-white border-green-200 animate-bounce cursor-pointer opacity-100 scale-110' 
                         : 'bg-white text-gray-300 border-gray-100 opacity-50 cursor-not-allowed'}
                      ${(!isReading && !finished) ? 'opacity-20' : ''}
                      `}>
                      {isLast ? 'üèÅ' : 'üëâ'}
                   </button>
                </div>

                <div className="z-10 flex flex-col items-center gap-8 w-full max-w-2xl">
                   {currentItem.image && (
                     <div className="bg-white p-3 rounded-2xl shadow-lg transform -rotate-2 border-2 border-gray-100">
                        <img src={currentItem.image} className="h-48 md:h-64 object-contain rounded-lg" alt="imagen" />
                     </div>
                   )}
                   
                   <div className="text-center min-h-[120px] flex items-center justify-center w-full">
                      {renderText()}
                   </div>

                   {/* BOT√ìN CENTRAL DE CONFIRMACI√ìN */}
                   {waitingForNext && isReading && (
                     <button 
                        onClick={handleNext}
                        className="mt-6 bg-kid-green hover:bg-green-500 text-white text-3xl font-extrabold py-4 px-10 rounded-full shadow-[0_6px_0_0_#047857] hover:shadow-[0_3px_0_0_#047857] hover:translate-y-1 transition-all animate-bounce flex items-center gap-3 border-4 border-white z-50 pointer-events-auto"
                     >
                        ‚úÖ ¬°Termin√©!
                     </button>
                   )}
                </div>
              </div>

              {/* Controles inferiores */}
              <div className="bg-white p-6 border-t flex flex-col items-center gap-4">
                {micError && isReading && (
                  <p className="text-red-500 text-sm font-bold bg-red-50 px-3 py-1 rounded-lg border border-red-200">
                    ‚ö†Ô∏è Micr√≥fono bloqueado (modo lectura pr√°ctica).
                  </p>
                )}

                {!isReading && !finished && (
                  <button onClick={startSession} className="bg-kid-green hover:bg-green-400 text-white text-3xl font-extrabold py-4 px-12 rounded-full shadow-[0_6px_0_0_#05b586] btn-press transition-all flex gap-3 items-center">
                    ‚ñ∂Ô∏è ¬°COMENZAR!
                  </button>
                )}

                {isReading && (
                   <div className="flex flex-col items-center">
                     <span className="flex items-center gap-2 text-red-500 font-bold uppercase tracking-widest text-sm animate-pulse">
                       üî¥ Grabando sesi√≥n
                     </span>
                     <button onClick={finishSession} className="text-gray-400 underline text-sm mt-2 hover:text-gray-600">
                       Detener lecci√≥n
                     </button>
                   </div>
                )}

                {finished && (
                  <div className="flex flex-col items-center gap-4 w-full">
                    <h3 className="text-2xl font-bold text-kid-blue">üéâ ¬°Lecci√≥n Terminada! üéâ</h3>
                    
                    {audioBlob && (
                      <button 
                        onClick={() => {
                           const audio = new Audio(URL.createObjectURL(audioBlob));
                           audio.play();
                        }}
                        className="bg-blue-400 hover:bg-blue-500 text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg transition-all flex items-center gap-2"
                      >
                         üîä Escuchar mi lectura
                      </button>
                    )}

                    {!feedback ? (
                       <button onClick={pedirFeedback} disabled={loadingFeedback} className="bg-kid-purple text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg hover:bg-purple-600 transition-all disabled:opacity-50">
                          {loadingFeedback ? '‚è≥ El Profe est√° escuchando...' : '‚ú® ¬øQu√© dice el Profe M√°gico?'}
                       </button>
                    ) : (
                       <div className="bg-yellow-50 border-l-4 border-kid-yellow p-4 rounded text-left max-w-lg">
                          <p className="text-gray-600 font-bold mb-1">ü§ñ Profe IA:</p>
                          <p className="text-xl italic text-gray-800">"{feedback}"</p>
                       </div>
                    )}
                    
                    <button onClick={() => { setFinished(false); setCurrentIndex(0); setAudioBlob(null); setFeedback(null); }} className="text-gray-500 font-bold mt-2 hover:text-kid-blue">
                       üîÑ Repetir Lecci√≥n
                    </button>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // --- MENU PRINCIPAL ---
        const App = () => {
          const [level, setLevel] = useState(null);
          const [model, setModel] = useState(ModelType.SYLLABIC);

          if (level) {
             return (
               <div className="min-h-screen bg-blue-100 p-2 md:p-6 flex items-center justify-center">
                 <ActiveLesson levelId={level} model={model} onBack={() => setLevel(null)} />
               </div>
             )
          }

          return (
            <div className="min-h-screen bg-gradient-to-b from-cyan-50 to-blue-100 p-6 font-sans">
              <div className="max-w-5xl mx-auto">
                <header className="text-center py-10">
                  <h1 className="text-5xl md:text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-kid-blue to-kid-pink drop-shadow-sm mb-4">
                    Aprende a Leer
                  </h1>
                  <p className="text-xl text-gray-500 font-medium">¬°Tu aventura m√°gica con las letras!</p>
                </header>

                <div className="flex justify-center mb-10">
                  <div className="bg-white p-2 rounded-full shadow-md inline-flex flex-wrap justify-center gap-2">
                    <button onClick={() => setModel(ModelType.SYLLABIC)} 
                      className={`px-6 py-3 rounded-full text-lg font-bold transition-all ${model === ModelType.SYLLABIC ? 'bg-kid-yellow text-gray-900 shadow-sm' : 'text-gray-400 hover:bg-gray-50'}`}>
                      üê¢ Modo Sil√°bico
                    </button>
                    <button onClick={() => setModel(ModelType.FLUENCY)} 
                      className={`px-6 py-3 rounded-full text-lg font-bold transition-all ${model === ModelType.FLUENCY ? 'bg-kid-green text-white shadow-sm' : 'text-gray-400 hover:bg-gray-50'}`}>
                      üêá Modo Fluidez
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  {LEVELS.map(lvl => (
                    <button key={lvl.id} onClick={() => setLevel(lvl.id)}
                      className="group bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 text-left border-b-8 border-gray-100 hover:border-kid-blue relative overflow-hidden">
                      <div className={`absolute top-0 right-0 w-24 h-24 rounded-bl-full opacity-20 ${lvl.color} transition-transform group-hover:scale-150`}></div>
                      <div className={`w-16 h-16 rounded-2xl ${lvl.color} flex items-center justify-center text-3xl shadow-inner mb-4`}>
                        {lvl.id === 'level-1' ? 'üÖ∞Ô∏è' : lvl.id === 'level-2' ? 'üó£Ô∏è' : lvl.id === 'level-3' ? 'üìú' : lvl.id === 'level-4' ? 'üéà' : lvl.id === 'level-5' ? 'ü¶Å' : lvl.id === 'level-6' ? 'üë™' : 'üìñ'}
                      </div>
                      <h3 className="text-2xl font-bold text-gray-800 mb-2 leading-tight">{lvl.title}</h3>
                      <p className="text-sm text-gray-400 font-medium">{lvl.description}</p>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>