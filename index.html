<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aprende a Leer - Versión Mejorada</title>
    
    <!-- 1. Estilos Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'kid-blue': '#4CC9F0',
              'kid-pink': '#F72585',
              'kid-yellow': '#FFD60A',
              'kid-green': '#06D6A0',
              'kid-purple': '#7209B7',
              'kid-orange': '#FB5607',
            },
            fontFamily: {
              sans: ['Comic Sans MS', 'Comic Sans', 'cursive', 'sans-serif'],
            },
            animation: {
              'bounce-slow': 'bounce 3s infinite',
            }
          }
        }
      }
    </script>

    <!-- 2. Librerías React (Versiones UMD Universales) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Google Gemini SDK -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
    <script type="module">
      import { GoogleGenAI } from "@google/genai";
      window.GoogleGenAI = GoogleGenAI;
    </script>

    <style>
      body { background-color: #f0fdfa; user-select: none; }
      .btn-press:active { transform: scale(0.95); }
      /* Estilo para el slider */
      input[type=range] {
        height: 34px;
        -webkit-appearance: none;
        margin: 10px 0;
        width: 100%;
        background: transparent;
      }
      input[type=range]:focus { outline: none; }
      input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 12px;
        cursor: pointer;
        background: #E5E7EB;
        border-radius: 25px;
      }
      input[type=range]::-webkit-slider-thumb {
        height: 28px;
        width: 28px;
        border-radius: 50%;
        background: #F72585;
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <!-- 5. LÓGICA DE LA APLICACIÓN -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- DATOS Y CONSTANTES ---
        const API_KEY = ""; // PON TU API KEY AQUÍ

        const ModelType = {
          SYLLABIC: 'silabico',
          FLUENCY: 'fluidez'
        };

        const IMG_BASE = "https://picsum.photos/seed";
        
        const LEVELS = [
          {
            id: 'level-1',
            title: 'Nivel 1: Las Vocales',
            description: 'Aprende las vocales con imágenes.',
            color: 'bg-kid-blue',
            items: [
              { id: 'l1-1', type: 'vowel', text: 'a', image: `${IMG_BASE}/airplane/300/300`, syllables: ['a'] },
              { id: 'l1-2', type: 'vowel', text: 'e', image: `${IMG_BASE}/elephant/300/300`, syllables: ['e'] },
              { id: 'l1-3', type: 'vowel', text: 'i', image: `${IMG_BASE}/church/300/300`, syllables: ['i'] },
              { id: 'l1-4', type: 'vowel', text: 'o', image: `${IMG_BASE}/bear/300/300`, syllables: ['o'] },
              { id: 'l1-5', type: 'vowel', text: 'u', image: `${IMG_BASE}/grapes/300/300`, syllables: ['u'] },
            ]
          },
          {
            id: 'level-2',
            title: 'Nivel 2: Sílabas (M)',
            description: 'Palabras con Ma, Me, Mi, Mo, Mu.',
            color: 'bg-kid-pink',
            items: [
              { id: 'l2-1', type: 'word', text: 'mamá', syllables: ['ma', 'má'], image: `${IMG_BASE}/mom/300/300` },
              { id: 'l2-2', type: 'word', text: 'ama', syllables: ['a', 'ma'] },
              { id: 'l2-3', type: 'word', text: 'mami', syllables: ['ma', 'mi'] },
              { id: 'l2-4', type: 'word', text: 'amo', syllables: ['a', 'mo'] },
              { id: 'l2-5', type: 'word', text: 'mima', syllables: ['mi', 'ma'] },
              { id: 'l2-6', type: 'word', text: 'eme', syllables: ['e', 'me'] },
              { id: 'l2-7', type: 'word', text: 'memo', syllables: ['me', 'mo'] },
              { id: 'l2-8', type: 'word', text: 'mimo', syllables: ['mi', 'mo'] },
              { id: 'l2-9', type: 'word', text: 'mío', syllables: ['mí', 'o'] },
              { id: 'l2-10', type: 'word', text: 'ame', syllables: ['a', 'me'] },
              { id: 'l2-11', type: 'word', text: 'mía', syllables: ['mí', 'a'] },
              { id: 'l2-12', type: 'word', text: 'miau', syllables: ['miau'] },
            ]
          },
          {
            id: 'level-3',
            title: 'Nivel 3: Frases (M)',
            description: 'Leyendo oraciones con M.',
            color: 'bg-kid-green',
            items: [
              { 
                id: 'l3-1', 
                type: 'sentence', 
                text: 'amo a mi mamá', 
                words: ['amo', 'a', 'mi', 'mamá'],
                syllables: ['a', 'mo', ' ', 'a', ' ', 'mi', ' ', 'ma', 'má'],
                image: `${IMG_BASE}/lovemom/400/200` 
              },
              { 
                id: 'l3-2', 
                type: 'sentence', 
                text: 'mi mamá me ama', 
                words: ['mi', 'mamá', 'me', 'ama'],
                syllables: ['mi', ' ', 'ma', 'má', ' ', 'me', ' ', 'a', 'ma']
              },
              { 
                id: 'l3-3', 
                type: 'sentence', 
                text: 'mimo a mi mamá', 
                words: ['mimo', 'a', 'mi', 'mamá'],
                syllables: ['mi', 'mo', ' ', 'a', ' ', 'mi', ' ', 'ma', 'má']
              },
              { 
                id: 'l3-4', 
                type: 'sentence', 
                text: 'mi mamá me mima', 
                words: ['mi', 'mamá', 'me', 'mima'],
                syllables: ['mi', ' ', 'ma', 'má', ' ', 'me', ' ', 'mi', 'ma']
              },
            ]
          },
          {
            id: 'level-4',
            title: 'Nivel 4: Sílabas (P)',
            description: 'Palabras con Pa, Pe, Pi, Po, Pu.',
            color: 'bg-kid-purple',
            items: [
              { id: 'l4-s1', type: 'word', text: 'pa', syllables: ['pa'], image: `${IMG_BASE}/father/300/300` },
              { id: 'l4-s2', type: 'word', text: 'pe', syllables: ['pe'], image: `${IMG_BASE}/ball/300/300` },
              { id: 'l4-s3', type: 'word', text: 'pi', syllables: ['pi'], image: `${IMG_BASE}/pineapple/300/300` },
              { id: 'l4-s4', type: 'word', text: 'po', syllables: ['po'], image: `${IMG_BASE}/chick/300/300` },
              { id: 'l4-s5', type: 'word', text: 'pu', syllables: ['pu'], image: `${IMG_BASE}/fist/300/300` },
              { id: 'l4-1', type: 'word', text: 'papá', syllables: ['pa', 'pá'] },
              { id: 'l4-2', type: 'word', text: 'mopa', syllables: ['mo', 'pa'] },
              { id: 'l4-3', type: 'word', text: 'popa', syllables: ['po', 'pa'] },
              { id: 'l4-4', type: 'word', text: 'papi', syllables: ['pa', 'pi'] },
              { id: 'l4-5', type: 'word', text: 'pepe', syllables: ['pe', 'pe'] },
              { id: 'l4-6', type: 'word', text: 'pipa', syllables: ['pi', 'pa'] },
              { id: 'l4-7', type: 'word', text: 'pepa', syllables: ['pe', 'pa'] },
              { id: 'l4-8', type: 'word', text: 'mapa', syllables: ['ma', 'pa'] },
              { id: 'l4-9', type: 'word', text: 'púa', syllables: ['pú', 'a'] },
              { id: 'l4-10', type: 'word', text: 'pío', syllables: ['pí', 'o'] },
              { id: 'l4-11', type: 'word', text: 'pía', syllables: ['pí', 'a'] },
              { id: 'l4-12', type: 'word', text: 'puma', syllables: ['pu', 'ma'] },
            ]
          },
          {
            id: 'level-5',
            title: 'Nivel 5: Sílabas (L)',
            description: 'Palabras con La, Le, Li, Lo, Lu.',
            color: 'bg-kid-orange',
            items: [
              { id: 'l5-s1', type: 'word', text: 'la', syllables: ['la'], image: `${IMG_BASE}/pencil/300/300` },
              { id: 'l5-s2', type: 'word', text: 'le', syllables: ['le'], image: `${IMG_BASE}/milk/300/300` },
              { id: 'l5-s3', type: 'word', text: 'li', syllables: ['li'], image: `${IMG_BASE}/lemon/300/300` },
              { id: 'l5-s4', type: 'word', text: 'lo', syllables: ['lo'], image: `${IMG_BASE}/wolf/300/300` },
              { id: 'l5-s5', type: 'word', text: 'lu', syllables: ['lu'], image: `${IMG_BASE}/moon/300/300` },
              { id: 'l5-1', type: 'word', text: 'loma', syllables: ['lo', 'ma'] },
              { id: 'l5-2', type: 'word', text: 'lima', syllables: ['li', 'ma'] },
              { id: 'l5-3', type: 'word', text: 'lame', syllables: ['la', 'me'] },
              { id: 'l5-4', type: 'word', text: 'lomo', syllables: ['lo', 'mo'] },
              { id: 'l5-5', type: 'word', text: 'malo', syllables: ['ma', 'lo'] },
              { id: 'l5-6', type: 'word', text: 'mula', syllables: ['mu', 'la'] },
              { id: 'l5-7', type: 'word', text: 'pelo', syllables: ['pe', 'lo'] },
              { id: 'l5-8', type: 'word', text: 'pila', syllables: ['pi', 'la'] },
              { id: 'l5-9', type: 'word', text: 'paloma', syllables: ['pa', 'lo', 'ma'] },
              { id: 'l5-10', type: 'word', text: 'pomelo', syllables: ['po', 'me', 'lo'] },
              { id: 'l5-11', type: 'word', text: 'lola', syllables: ['lo', 'la'] },
              { id: 'l5-12', type: 'word', text: 'lalo', syllables: ['la', 'lo'] },
              { 
                id: 'l5-13', 
                type: 'sentence', 
                text: 'lola asea la sala', 
                words: ['lola', 'asea', 'la', 'sala'],
                syllables: ['lo', 'la', ' ', 'a', 'se', 'a', ' ', 'la', ' ', 'sa', 'la']
              }
            ]
          },
          {
            id: 'level-6',
            title: 'Nivel 6: Frases (P)',
            description: 'Oraciones con Papá y Mamá.',
            color: 'bg-kid-pink',
            items: [
              { 
                id: 'l6-1', 
                type: 'sentence', 
                text: 'papá ama a mamá', 
                words: ['papá', 'ama', 'a', 'mamá'],
                syllables: ['pa', 'pá', ' ', 'a', 'ma', ' ', 'a', ' ', 'ma', 'má'],
                image: `${IMG_BASE}/parents/400/250`
              },
              { 
                id: 'l6-2', 
                type: 'sentence', 
                text: 'mamá ama a papi', 
                words: ['mamá', 'ama', 'a', 'papi'],
                syllables: ['ma', 'má', ' ', 'a', 'ma', ' ', 'a', ' ', 'pa', 'pi']
              },
              { 
                id: 'l6-3', 
                type: 'sentence', 
                text: 'mi papá me ama', 
                words: ['mi', 'papá', 'me', 'ama'],
                syllables: ['mi', ' ', 'pa', 'pá', ' ', 'me', ' ', 'a', 'ma']
              },
              { 
                id: 'l6-4', 
                type: 'sentence', 
                text: 'amo a mi papá', 
                words: ['amo', 'a', 'mi', 'papá'],
                syllables: ['a', 'mo', ' ', 'a', ' ', 'mi', ' ', 'pa', 'pá']
              }
            ]
          },
          {
            id: 'level-7',
            title: 'Nivel 7: Repaso (L)',
            description: 'Más práctica: loma, palo, ala...',
            color: 'bg-kid-yellow',
            items: [
              { id: 'l7-1', type: 'word', text: 'loma', syllables: ['lo', 'ma'], image: `${IMG_BASE}/hill/300/300` },
              { id: 'l7-2', type: 'word', text: 'palo', syllables: ['pa', 'lo'], image: `${IMG_BASE}/stick/300/300` },
              { id: 'l7-3', type: 'word', text: 'ala', syllables: ['a', 'la'], image: `${IMG_BASE}/wing/300/300` },
              { id: 'l7-4', type: 'word', text: 'pala', syllables: ['pa', 'la'], image: `${IMG_BASE}/shovel/300/300` },
              { id: 'l7-5', type: 'word', text: 'lima', syllables: ['li', 'ma'], image: `${IMG_BASE}/lime/300/300` },
              { id: 'l7-6', type: 'word', text: 'pila', syllables: ['pi', 'la'], image: `${IMG_BASE}/battery/300/300` },
              { id: 'l7-7', type: 'word', text: 'lee', syllables: ['le', 'e'], image: `${IMG_BASE}/reading/300/300` },
              { id: 'l7-8', type: 'word', text: 'paloma', syllables: ['pa', 'lo', 'ma'], image: `${IMG_BASE}/pigeon/300/300` },
              { id: 'l7-9', type: 'word', text: 'lomo', syllables: ['lo', 'mo'], image: `${IMG_BASE}/meat/300/300` },
              { id: 'l7-10', type: 'word', text: 'lupa', syllables: ['lu', 'pa'], image: `${IMG_BASE}/magnifying/300/300` },
              { id: 'l7-11', type: 'word', text: 'mula', syllables: ['mu', 'la'], image: `${IMG_BASE}/mule/300/300` },
              { id: 'l7-12', type: 'word', text: 'lame', syllables: ['la', 'me'], image: `${IMG_BASE}/dog/300/300` },
            ]
          },
          {
            id: 'level-8',
            title: 'Nivel 8: Frases (L y P)',
            description: 'Oraciones complejas con L y P.',
            color: 'bg-kid-green',
            items: [
              { 
                id: 'l8-1', 
                type: 'sentence', 
                text: 'papá lima la pala', 
                words: ['papá', 'lima', 'la', 'pala'],
                syllables: ['pa', 'pá', ' ', 'li', 'ma', ' ', 'la', ' ', 'pa', 'la'],
                image: `${IMG_BASE}/shovel/400/250`
              },
              { 
                id: 'l8-2', 
                type: 'sentence', 
                text: 'mamá pela la papa', 
                words: ['mamá', 'pela', 'la', 'papa'],
                syllables: ['ma', 'má', ' ', 'pe', 'la', ' ', 'la', ' ', 'pa', 'pa'],
                image: `${IMG_BASE}/potato/400/250`
              },
              { 
                id: 'l8-3', 
                type: 'sentence', 
                text: 'Lilí pule la lupa', 
                words: ['Lilí', 'pule', 'la', 'lupa'],
                syllables: ['Li', 'lí', ' ', 'pu', 'le', ' ', 'la', ' ', 'lu', 'pa'],
                image: `${IMG_BASE}/magnifying/400/250`
              },
              { 
                id: 'l8-4', 
                type: 'sentence', 
                text: 'Lola ama a Pepe', 
                words: ['Lola', 'ama', 'a', 'Pepe'],
                syllables: ['Lo', 'la', ' ', 'a', 'ma', ' ', 'a', ' ', 'Pe', 'pe'],
                image: `${IMG_BASE}/hug/400/250`
              }
            ]
          },
          {
            id: 'level-9',
            title: 'Nivel 9: Sílabas (S)',
            description: 'Palabras con Sa, Se, Si, So, Su.',
            color: 'bg-kid-blue',
            items: [
              // Sílabas con imágenes
              { id: 'l9-s1', type: 'word', text: 'sa', syllables: ['sa'], image: `${IMG_BASE}/frog/300/300` },
              { id: 'l9-s2', type: 'word', text: 'se', syllables: ['se'], image: `${IMG_BASE}/trafficlight/300/300` },
              { id: 'l9-s3', type: 'word', text: 'si', syllables: ['si'], image: `${IMG_BASE}/chair/300/300` },
              { id: 'l9-s4', type: 'word', text: 'so', syllables: ['so'], image: `${IMG_BASE}/soup/300/300` },
              { id: 'l9-s5', type: 'word', text: 'su', syllables: ['su'], image: `${IMG_BASE}/math/300/300` },
              
              // Palabras del texto
              { id: 'l9-1', type: 'word', text: 'suma', syllables: ['su', 'ma'] },
              { id: 'l9-2', type: 'word', text: 'sopa', syllables: ['so', 'pa'] },
              { id: 'l9-3', type: 'word', text: 'asa', syllables: ['a', 'sa'] },
              
              { id: 'l9-4', type: 'word', text: 'oso', syllables: ['o', 'so'] },
              { id: 'l9-5', type: 'word', text: 'sima', syllables: ['si', 'ma'] },
              { id: 'l9-6', type: 'word', text: 'sala', syllables: ['sa', 'la'] },
              
              { id: 'l9-7', type: 'word', text: 'misa', syllables: ['mi', 'sa'] },
              { id: 'l9-8', type: 'word', text: 'sapo', syllables: ['sa', 'po'] },
              { id: 'l9-9', type: 'word', text: 'peso', syllables: ['pe', 'so'] },
              
              { id: 'l9-10', type: 'word', text: 'piso', syllables: ['pi', 'so'] },
              { id: 'l9-11', type: 'word', text: 'osa', syllables: ['o', 'sa'] },
              { id: 'l9-12', type: 'word', text: 'masa', syllables: ['ma', 'sa'] }
            ]
          },
          {
            id: 'level-10',
            title: 'Nivel 10: Frases (S)',
            description: 'Oraciones con S, P, L y M.',
            color: 'bg-kid-purple',
            items: [
              {
                id: 'l10-1',
                type: 'sentence',
                text: 'ese oso pasea',
                words: ['ese', 'oso', 'pasea'],
                syllables: ['e', 'se', ' ', 'o', 'so', ' ', 'pa', 'se', 'a'],
                image: `${IMG_BASE}/bear_walking/400/250`
              },
              {
                id: 'l10-2',
                type: 'sentence',
                text: 'mi oso se asoma',
                words: ['mi', 'oso', 'se', 'asoma'],
                syllables: ['mi', ' ', 'o', 'so', ' ', 'se', ' ', 'a', 'so', 'ma'],
                image: `${IMG_BASE}/bear_peeking/400/250`
              },
              {
                id: 'l10-3',
                type: 'sentence',
                text: 'Lila pasa la sopa',
                words: ['Lila', 'pasa', 'la', 'sopa'],
                syllables: ['Li', 'la', ' ', 'pa', 'sa', ' ', 'la', ' ', 'so', 'pa'],
                image: `${IMG_BASE}/girl_soup/400/250`
              },
              {
                id: 'l10-4',
                type: 'sentence',
                text: 'la mesa es de mamá',
                words: ['la', 'mesa', 'es', 'de', 'mamá'],
                syllables: ['la', ' ', 'me', 'sa', ' ', 'es', ' ', 'de', ' ', 'ma', 'má'],
                image: `${IMG_BASE}/table/400/250`
              }
            ]
          },
          {
            id: 'level-11',
            title: 'Nivel 11: Sílabas (T)',
            description: 'Palabras con Ta, Te, Ti, To, Tu.',
            color: 'bg-kid-orange',
            items: [
              // Sílabas con imágenes
              { id: 'l11-s1', type: 'word', text: 'ta', syllables: ['ta'], image: `${IMG_BASE}/cup/300/300` },
              { id: 'l11-s2', type: 'word', text: 'te', syllables: ['te'], image: `${IMG_BASE}/tv/300/300` },
              { id: 'l11-s3', type: 'word', text: 'ti', syllables: ['ti'], image: `${IMG_BASE}/scissors/300/300` },
              { id: 'l11-s4', type: 'word', text: 'to', syllables: ['to'], image: `${IMG_BASE}/tomato/300/300` },
              { id: 'l11-s5', type: 'word', text: 'tu', syllables: ['tu'], image: `${IMG_BASE}/pipe/300/300` },
              
              // Palabras del texto
              { id: 'l11-1', type: 'word', text: 'tomate', syllables: ['to', 'ma', 'te'] },
              { id: 'l11-2', type: 'word', text: 'teme', syllables: ['te', 'me'] },
              { id: 'l11-3', type: 'word', text: 'mete', syllables: ['me', 'te'] },
              
              { id: 'l11-4', type: 'word', text: 'temo', syllables: ['te', 'mo'] },
              { id: 'l11-5', type: 'word', text: 'mata', syllables: ['ma', 'ta'] },
              { id: 'l11-6', type: 'word', text: 'moto', syllables: ['mo', 'to'] },
              
              { id: 'l11-7', type: 'word', text: 'timo', syllables: ['ti', 'mo'] },
              { id: 'l11-8', type: 'word', text: 'totuma', syllables: ['to', 'tu', 'ma'] },
              { id: 'l11-9', type: 'word', text: 'toma', syllables: ['to', 'ma'] },
              
              { id: 'l11-10', type: 'word', text: 'lata', syllables: ['la', 'ta'] },
              { id: 'l11-11', type: 'word', text: 'tapa', syllables: ['ta', 'pa'] },
              { id: 'l11-12', type: 'word', text: 'pato', syllables: ['pa', 'to'] }
            ]
          },
          {
            id: 'level-12',
            title: 'Nivel 12: Frases (T)',
            description: 'Oraciones con T, M, P, L y S.',
            color: 'bg-kid-green',
            items: [
              {
                id: 'l12-1',
                type: 'sentence',
                text: 'toma la pelota',
                words: ['toma', 'la', 'pelota'],
                syllables: ['to', 'ma', ' ', 'la', ' ', 'pe', 'lo', 'ta'],
                image: `${IMG_BASE}/ball_catch/400/250`
              },
              {
                id: 'l12-2',
                type: 'sentence',
                text: 'mamá toma té',
                words: ['mamá', 'toma', 'té'],
                syllables: ['ma', 'má', ' ', 'to', 'ma', ' ', 'té'],
                image: `${IMG_BASE}/tea/400/250`
              },
              {
                id: 'l12-3',
                type: 'sentence',
                text: 'toma ese tomate',
                words: ['toma', 'ese', 'tomate'],
                syllables: ['to', 'ma', ' ', 'e', 'se', " ", 'to', 'ma', 'te'],
                image: `${IMG_BASE}/tomato_hand/400/250`
              },
              {
                id: 'l12-4',
                type: 'sentence',
                text: 'Pepe mete la moto',
                words: ['Pepe', 'mete', 'la', 'moto'],
                syllables: ['Pe', 'pe', ' ', 'me', 'te', " ", 'la', " ", 'mo', 'to'],
                image: `${IMG_BASE}/motorcycle_garage/400/250`
              }
            ]
          },
          {
            id: 'level-13',
            title: 'Nivel 13: Sílabas (N)',
            description: 'Palabras con Na, Ne, Ni, No, Nu.',
            color: 'bg-kid-blue',
            items: [
              // Sílabas con imágenes
              { id: 'l13-s1', type: 'word', text: 'na', syllables: ['na'], image: `${IMG_BASE}/orange/300/300` },
              { id: 'l13-s2', type: 'word', text: 'ne', syllables: ['ne'], image: `${IMG_BASE}/baby/300/300` },
              { id: 'l13-s3', type: 'word', text: 'ni', syllables: ['ni'], image: `${IMG_BASE}/nest/300/300` },
              { id: 'l13-s4', type: 'word', text: 'no', syllables: ['no'], image: `${IMG_BASE}/bride/300/300` },
              { id: 'l13-s5', type: 'word', text: 'nu', syllables: ['nu'], image: `${IMG_BASE}/cloud/300/300` },
              
              // Palabras del texto
              { id: 'l13-1', type: 'word', text: 'nena', syllables: ['ne', 'na'] },
              { id: 'l13-2', type: 'word', text: 'luna', syllables: ['lu', 'na'] },
              { id: 'l13-3', type: 'word', text: 'mona', syllables: ['mo', 'na'] },
              
              { id: 'l13-4', type: 'word', text: 'maní', syllables: ['ma', 'ní'] },
              { id: 'l13-5', type: 'word', text: 'tina', syllables: ['ti', 'na'] },
              { id: 'l13-6', type: 'word', text: 'nené', syllables: ['ne', 'né'] },
              
              { id: 'l13-7', type: 'word', text: 'pino', syllables: ['pi', 'no'] },
              { id: 'l13-8', type: 'word', text: 'enano', syllables: ['e', 'na', 'no'] },
              { id: 'l13-9', type: 'word', text: 'mano', syllables: ['ma', 'no'] },
              
              { id: 'l13-10', type: 'word', text: 'nata', syllables: ['na', 'ta'] },
              { id: 'l13-11', type: 'word', text: 'pana', syllables: ['pa', 'na'] },
              { id: 'l13-12', type: 'word', text: 'nota', syllables: ['no', 'ta'] }
            ]
          },
          {
            id: 'level-14',
            title: 'Nivel 14: Frases (N)',
            description: 'Oraciones con N, P, L y M.',
            color: 'bg-kid-pink',
            items: [
              {
                id: 'l14-1',
                type: 'sentence',
                text: 'la nena pasea sola',
                words: ['la', 'nena', 'pasea', 'sola'],
                syllables: ['la', ' ', 'ne', 'na', ' ', 'pa', 'se', 'a', ' ', 'so', 'la'],
                image: `${IMG_BASE}/girl_walking/400/250`
              },
              {
                id: 'l14-2',
                type: 'sentence',
                text: 'papá ama al nené',
                words: ['papá', 'ama', 'al', 'nené'],
                syllables: ['pa', 'pá', ' ', 'a', 'ma', ' ', 'al', ' ', 'ne', 'né'],
                image: `${IMG_BASE}/dad_baby/400/250`
              },
              {
                id: 'l14-3',
                type: 'sentence',
                text: 'Elena toma nata',
                words: ['Elena', 'toma', 'nata'],
                syllables: ['E', 'le', 'na', ' ', 'to', 'ma', ' ', 'na', 'ta'],
                image: `${IMG_BASE}/girl_eating/400/250`
              },
              {
                id: 'l14-4',
                type: 'sentence',
                text: 'Lina ama a su papá',
                words: ['Lina', 'ama', 'a', 'su', 'papá'],
                syllables: ['Li', 'na', ' ', 'a', 'ma', ' ', 'a', ' ', 'su', ' ', 'pa', 'pá'],
                image: `${IMG_BASE}/girl_dad/400/250`
              }
            ]
          },
          {
            id: 'level-15',
            title: 'Nivel 15: Sílabas (D)',
            description: 'Palabras con Da, De, Di, Do, Du.',
            color: 'bg-kid-purple',
            items: [
              // Sílabas con imágenes
              { id: 'l15-s1', type: 'word', text: 'da', syllables: ['da'], image: `${IMG_BASE}/dice/300/300` },
              { id: 'l15-s2', type: 'word', text: 'de', syllables: ['de'], image: `${IMG_BASE}/finger/300/300` },
              { id: 'l15-s3', type: 'word', text: 'di', syllables: ['di'], image: `${IMG_BASE}/diploma/300/300` },
              { id: 'l15-s4', type: 'word', text: 'do', syllables: ['do'], image: `${IMG_BASE}/domino/300/300` },
              { id: 'l15-s5', type: 'word', text: 'du', syllables: ['du'], image: `${IMG_BASE}/shower/300/300` },
              
              // Palabras del texto
              { id: 'l15-1', type: 'word', text: 'dado', syllables: ['da', 'do'] },
              { id: 'l15-2', type: 'word', text: 'dedo', syllables: ['de', 'do'] },
              { id: 'l15-3', type: 'word', text: 'dime', syllables: ['di', 'me'] },
              
              { id: 'l15-4', type: 'word', text: 'dame', syllables: ['da', 'me'] },
              { id: 'l15-5', type: 'word', text: 'dama', syllables: ['da', 'ma'] },
              { id: 'l15-6', type: 'word', text: 'lado', syllables: ['la', 'do'] },
              
              { id: 'l15-7', type: 'word', text: 'nada', syllables: ['na', 'da'] },
              { id: 'l15-8', type: 'word', text: 'lodo', syllables: ['lo', 'do'] },
              { id: 'l15-9', type: 'word', text: 'duda', syllables: ['du', 'da'] },
              
              { id: 'l15-10', type: 'word', text: 'moda', syllables: ['mo', 'da'] },
              { id: 'l15-11', type: 'word', text: 'día', syllables: ['dí', 'a'] },
              { id: 'l15-12', type: 'word', text: 'dale', syllables: ['da', 'le'] }
            ]
          },
          {
            id: 'level-16',
            title: 'Nivel 16: Frases (D)',
            description: 'Oraciones con D, N, P, L, S y M.',
            color: 'bg-kid-green',
            items: [
              {
                id: 'l16-1',
                type: 'sentence',
                text: 'me duele el dedo',
                words: ['me', 'duele', 'el', 'dedo'],
                syllables: ['me', ' ', 'due', 'le', ' ', 'el', ' ', 'de', 'do'],
                image: `${IMG_BASE}/ouch_finger/400/250`
              },
              {
                id: 'l16-2',
                type: 'sentence',
                text: 'dame esa pelota',
                words: ['dame', 'esa', 'pelota'],
                syllables: ['da', 'me', ' ', 'e', 'sa', ' ', 'pe', 'lo', 'ta'],
                image: `${IMG_BASE}/giving_ball/400/250`
              },
              {
                id: 'l16-3',
                type: 'sentence',
                text: 'Adela me saluda',
                words: ['Adela', 'me', 'saluda'],
                syllables: ['A', 'de', 'la', ' ', 'me', ' ', 'sa', 'lu', 'da'],
                image: `${IMG_BASE}/girl_hello/400/250`
              },
              {
                id: 'l16-4',
                type: 'sentence',
                text: 'pásame ese dado',
                words: ['pásame', 'ese', 'dado'],
                syllables: ['pá', 'sa', 'me', ' ', 'e', 'se', ' ', 'da', 'do'],
                image: `${IMG_BASE}/playing_dice/400/250`
              }
            ]
          },
          {
            id: 'level-17',
            title: 'Nivel 17: Sílabas (C)',
            description: 'Palabras con Ca, Co, Cu.',
            color: 'bg-kid-orange',
            items: [
              // Sílabas con imágenes
              { id: 'l17-s1', type: 'word', text: 'ca', syllables: ['ca'], image: `${IMG_BASE}/house/300/300` },
              { id: 'l17-s2', type: 'word', text: 'co', syllables: ['co'], image: `${IMG_BASE}/coconut/300/300` },
              { id: 'l17-s3', type: 'word', text: 'cu', syllables: ['cu'], image: `${IMG_BASE}/cradle/300/300` },
              
              // Palabras del texto
              { id: 'l17-1', type: 'word', text: 'copa', syllables: ['co', 'pa'] },
              { id: 'l17-2', type: 'word', text: 'pico', syllables: ['pi', 'co'] },
              { id: 'l17-3', type: 'word', text: 'capa', syllables: ['ca', 'pa'] },
              
              { id: 'l17-4', type: 'word', text: 'cama', syllables: ['ca', 'ma'] },
              { id: 'l17-5', type: 'word', text: 'casa', syllables: ['ca', 'sa'] },
              { id: 'l17-6', type: 'word', text: 'cala', syllables: ['ca', 'la'] },
              
              { id: 'l17-7', type: 'word', text: 'coco', syllables: ['co', 'co'] },
              { id: 'l17-8', type: 'word', text: 'cuna', syllables: ['cu', 'na'] },
              { id: 'l17-9', type: 'word', text: 'cola', syllables: ['co', 'la'] },
              
              { id: 'l17-10', type: 'word', text: 'cana', syllables: ['ca', 'na'] },
              { id: 'l17-11', type: 'word', text: 'poco', syllables: ['po', 'co'] },
              { id: 'l17-12', type: 'word', text: 'come', syllables: ['co', 'me'] }
            ]
          },
          {
            id: 'level-18',
            title: 'Nivel 18: Frases (C)',
            description: 'Oraciones con C, P, L y M.',
            color: 'bg-kid-green',
            items: [
              {
                id: 'l18-1',
                type: 'sentence',
                text: 'Lolita come poco',
                words: ['Lolita', 'come', 'poco'],
                syllables: ['Lo', 'li', 'ta', ' ', 'co', 'me', ' ', 'po', 'co'],
                image: `${IMG_BASE}/girl_eating/400/250`
              },
              {
                id: 'l18-2',
                type: 'sentence',
                text: 'la copa es de mamá',
                words: ['la', 'copa', 'es', 'de', 'mamá'],
                syllables: ['la', ' ', 'co', 'pa', ' ', 'es', ' ', 'de', ' ', 'ma', 'má'],
                image: `${IMG_BASE}/cup/400/250`
              },
              {
                id: 'l18-3',
                type: 'sentence',
                text: 'papá tiene una casa',
                words: ['papá', 'tiene', 'una', 'casa'],
                syllables: ['pa', 'pá', ' ', 'tie', 'ne', ' ', 'u', 'na', ' ', 'ca', 'sa'],
                image: `${IMG_BASE}/dad_house/400/250`
              },
              {
                id: 'l18-4',
                type: 'sentence',
                text: 'Paco come coco',
                words: ['Paco', 'come', 'coco'],
                syllables: ['Pa', 'co', ' ', 'co', 'me', ' ', 'co', 'co'],
                image: `${IMG_BASE}/boy_eating/400/250`
              }
            ]
          },
          {
            id: 'level-19',
            title: 'Nivel 19: Sílabas (Que, Qui)',
            description: 'Palabras con Ca, Que, Qui, Co, Cu.',
            color: 'bg-kid-blue',
            items: [
              // Sílabas con imágenes
              { id: 'l19-s1', type: 'word', text: 'ca', syllables: ['ca'], image: `${IMG_BASE}/house/300/300` },
              { id: 'l19-s2', type: 'word', text: 'que', syllables: ['que'], image: `${IMG_BASE}/cheese/300/300` },
              { id: 'l19-s3', type: 'word', text: 'qui', syllables: ['qui'], image: `${IMG_BASE}/parasol/300/300` },
              { id: 'l19-s4', type: 'word', text: 'co', syllables: ['co'], image: `${IMG_BASE}/rabbit/300/300` },
              { id: 'l19-s5', type: 'word', text: 'cu', syllables: ['cu'], image: `${IMG_BASE}/cockroach/300/300` },

              // Palabras del texto
              { id: 'l19-1', type: 'word', text: 'casa', syllables: ['ca', 'sa'] },
              { id: 'l19-2', type: 'word', text: 'queso', syllables: ['que', 'so'] },
              { id: 'l19-3', type: 'word', text: 'quema', syllables: ['que', 'ma'] },

              { id: 'l19-4', type: 'word', text: 'quitasol', syllables: ['qui', 'ta', 'sol'] },
              { id: 'l19-5', type: 'word', text: 'toque', syllables: ['to', 'que'] },
              { id: 'l19-6', type: 'word', text: 'saco', syllables: ['sa', 'co'] },

              { id: 'l19-7', type: 'word', text: 'quita', syllables: ['qui', 'ta'] },
              { id: 'l19-8', type: 'word', text: 'cana', syllables: ['ca', 'na'] },
              { id: 'l19-9', type: 'word', text: 'queda', syllables: ['que', 'da'] },

              { id: 'l19-10', type: 'word', text: 'quiso', syllables: ['qui', 'so'] },
              { id: 'l19-11', type: 'word', text: 'coma', syllables: ['co', 'ma'] },
              { id: 'l19-12', type: 'word', text: 'paquete', syllables: ['pa', 'que', 'te'] }
            ]
          },
          {
            id: 'level-20',
            title: 'Nivel 20: Frases (Que, Qui)',
            description: 'Oraciones con Que, Qui, C, P, M, etc.',
            color: 'bg-kid-pink',
            items: [
              {
                id: 'l20-1',
                type: 'sentence',
                text: 'el mosquito pica',
                words: ['el', 'mosquito', 'pica'],
                syllables: ['el', ' ', 'mos', 'qui', 'to', ' ', 'pi', 'ca'],
                image: `${IMG_BASE}/mosquito/400/250`
              },
              {
                id: 'l20-2',
                type: 'sentence',
                text: 'toma ese queso',
                words: ['toma', 'ese', 'queso'],
                syllables: ['to', 'ma', ' ', 'e', 'se', ' ', 'que', 'so'],
                image: `${IMG_BASE}/cheese_plate/400/250`
              },
              {
                id: 'l20-3',
                type: 'sentence',
                text: 'Ana quita la cuna',
                words: ['Ana', 'quita', 'la', 'cuna'],
                syllables: ['A', 'na', ' ', 'qui', 'ta', ' ', 'la', ' ', 'cu', 'na'],
                image: `${IMG_BASE}/cradle/400/250`
              },
              {
                id: 'l20-4',
                type: 'sentence',
                text: 'Paco quiere un saco',
                words: ['Paco', 'quiere', 'un', 'saco'],
                syllables: ['Pa', 'co', ' ', 'quie', 're', ' ', 'un', ' ', 'sa', 'co'],
                image: `${IMG_BASE}/sack/400/250`
              }
            ]
          },
          {
            id: 'level-21',
            title: 'Nivel 21: Sílabas (B)',
            description: 'Palabras con Ba, Be, Bi, Bo, Bu.',
            color: 'bg-kid-orange',
            items: [
              // Sílabas con imágenes
              { id: 'l21-s1', type: 'word', text: 'ba', syllables: ['ba'], image: `${IMG_BASE}/barrel/300/300` },
              { id: 'l21-s2', type: 'word', text: 'be', syllables: ['be'], image: `${IMG_BASE}/baby/300/300` },
              { id: 'l21-s3', type: 'word', text: 'bi', syllables: ['bi'], image: `${IMG_BASE}/bicycle/300/300` },
              { id: 'l21-s4', type: 'word', text: 'bo', syllables: ['bo'], image: `${IMG_BASE}/ball/300/300` },
              { id: 'l21-s5', type: 'word', text: 'bu', syllables: ['bu'], image: `${IMG_BASE}/donkey/300/300` },

              // Palabras del texto
              { id: 'l21-1', type: 'word', text: 'bola', syllables: ['bo', 'la'] },
              { id: 'l21-2', type: 'word', text: 'bebida', syllables: ['be', 'bi', 'da'] },
              { id: 'l21-3', type: 'word', text: 'lobo', syllables: ['lo', 'bo'] },

              { id: 'l21-4', type: 'word', text: 'beso', syllables: ['be', 'so'] },
              { id: 'l21-5', type: 'word', text: 'tubo', syllables: ['tu', 'bo'] },
              { id: 'l21-6', type: 'word', text: 'bebé', syllables: ['be', 'bé'] },

              { id: 'l21-7', type: 'word', text: 'nube', syllables: ['nu', 'be'] },
              { id: 'l21-8', type: 'word', text: 'bata', syllables: ['ba', 'ta'] },
              { id: 'l21-9', type: 'word', text: 'bote', syllables: ['bo', 'te'] },

              { id: 'l21-10', type: 'word', text: 'buque', syllables: ['bu', 'que'] },
              { id: 'l21-11', type: 'word', text: 'bota', syllables: ['bo', 'ta'] },
              { id: 'l21-12', type: 'word', text: 'bala', syllables: ['ba', 'la'] }
            ]
          },
          {
            id: 'level-22',
            title: 'Nivel 22: Frases (B)',
            description: 'Oraciones con B.',
            color: 'bg-kid-green',
            items: [
              {
                id: 'l22-1',
                type: 'sentence',
                text: 'la casa es bonita',
                words: ['la', 'casa', 'es', 'bonita'],
                syllables: ['la', ' ', 'ca', 'sa', ' ', 'es', ' ', 'bo', 'ni', 'ta'],
                image: `${IMG_BASE}/house_nice/400/250`
              },
              {
                id: 'l22-2',
                type: 'sentence',
                text: 'beso a mi mamá',
                words: ['beso', 'a', 'mi', 'mamá'],
                syllables: ['be', 'so', ' ', 'a', ' ', 'mi', ' ', 'ma', 'má'],
                image: `${IMG_BASE}/kiss_mom/400/250`
              },
              {
                id: 'l22-3',
                type: 'sentence',
                text: 'el bebé toma sopa',
                words: ['el', 'bebé', 'toma', 'sopa'],
                syllables: ['el', ' ', 'be', 'bé', ' ', 'to', 'ma', ' ', 'so', 'pa'],
                image: `${IMG_BASE}/baby_soup/400/250`
              },
              {
                id: 'l22-4',
                type: 'sentence',
                text: 'el bate es bonito',
                words: ['el', 'bate', 'es', 'bonito'],
                syllables: ['el', ' ', 'ba', 'te', ' ', 'es', ' ', 'bo', 'ni', 'to'],
                image: `${IMG_BASE}/bat/400/250`
              }
            ]
          },
          {
            id: 'level-23',
            title: 'Nivel 23: Sílabas (V)',
            description: 'Palabras con Va, Ve, Vi, Vo, Vu.',
            color: 'bg-kid-blue',
            items: [
              // Sílabas con imágenes
              { id: 'l23-s1', type: 'word', text: 'va', syllables: ['va'], image: `${IMG_BASE}/cow/300/300` },
              { id: 'l23-s2', type: 'word', text: 've', syllables: ['ve'], image: `${IMG_BASE}/candle/300/300` },
              { id: 'l23-s3', type: 'word', text: 'vi', syllables: ['vi'], image: `${IMG_BASE}/window/300/300` },
              { id: 'l23-s4', type: 'word', text: 'vo', syllables: ['vo'], image: `${IMG_BASE}/steeringwheel/300/300` },
              { id: 'l23-s5', type: 'word', text: 'vu', syllables: ['vu'], image: `${IMG_BASE}/tumbling/300/300` },

              // Palabras del texto
              { id: 'l23-1', type: 'word', text: 'vaca', syllables: ['va', 'ca'] },
              { id: 'l23-2', type: 'word', text: 'vela', syllables: ['ve', 'la'] },
              { id: 'l23-3', type: 'word', text: 'volante', syllables: ['vo', 'lan', 'te'] },

              { id: 'l23-4', type: 'word', text: 'uva', syllables: ['u', 'va'] },
              { id: 'l23-5', type: 'word', text: 'vida', syllables: ['vi', 'da'] },
              { id: 'l23-6', type: 'word', text: 'pavo', syllables: ['pa', 'vo'] },

              { id: 'l23-7', type: 'word', text: 'lava', syllables: ['la', 'va'] },
              { id: 'l23-8', type: 'word', text: 'ave', syllables: ['a', 've'] },
              { id: 'l23-9', type: 'word', text: 'vino', syllables: ['vi', 'no'] },

              { id: 'l23-10', type: 'word', text: 'nave', syllables: ['na', 've'] },
              { id: 'l23-11', type: 'word', text: 'vivo', syllables: ['vi', 'vo'] },
              { id: 'l23-12', type: 'word', text: 'vacuna', syllables: ['va', 'cu', 'na'] }
            ]
          },
          {
            id: 'level-24',
            title: 'Nivel 24: Frases (V)',
            description: 'Oraciones con V.',
            color: 'bg-kid-pink',
            items: [
              {
                id: 'l24-1',
                type: 'sentence',
                text: 'esta vaca es de papá',
                words: ['esta', 'vaca', 'es', 'de', 'papá'],
                syllables: ['es', 'ta', ' ', 'va', 'ca', ' ', 'es', ' ', 'de', ' ', 'pa', 'pá'],
                image: `${IMG_BASE}/cow_farm/400/250`
              },
              {
                id: 'l24-2',
                type: 'sentence',
                text: 'el pavo es un ave',
                words: ['el', 'pavo', 'es', 'un', 'ave'],
                syllables: ['el', ' ', 'pa', 'vo', ' ', 'es', ' ', 'un', ' ', 'a', 've'],
                image: `${IMG_BASE}/turkey/400/250`
              },
              {
                id: 'l24-3',
                type: 'sentence',
                text: 'la vela es de Dina',
                words: ['la', 'vela', 'es', 'de', 'Dina'],
                syllables: ['la', ' ', 've', 'la', ' ', 'es', ' ', 'de', ' ', 'Di', 'na'],
                image: `${IMG_BASE}/candle_lit/400/250`
              },
              {
                id: 'l24-4',
                type: 'sentence',
                text: 'Elena lava el vaso',
                words: ['Elena', 'lava', 'el', 'vaso'],
                syllables: ['E', 'le', 'na', ' ', 'la', 'va', ' ', 'el', ' ', 'va', 'so'],
                image: `${IMG_BASE}/washing_dishes/400/250`
              }
            ]
          }
        ];

        // --- SERVICIO IA ---
        function blobToBase64(blob) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        }

        async function getTeacherFeedback(audioBlob, textRead) {
          if (!API_KEY || !window.GoogleGenAI) {
            return "¡Lo hiciste genial! Sigue practicando así de bien.";
          }
          try {
            const ai = new window.GoogleGenAI({ apiKey: API_KEY });
            const base64Audio = await blobToBase64(audioBlob);
            const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: {
                parts: [
                  { text: `Escucha este audio de un niño leyendo: "${textRead}". Responde en español, muy breve (10 palabras max), felicítalo con entusiasmo.` },
                  { inlineData: { mimeType: audioBlob.type || 'audio/webm', data: base64Audio } }
                ]
              }
            });
            return response.text || "¡Muy bien!";
          } catch (error) {
            console.error("Error IA:", error);
            return "¡Eres un campeón! ¡Sigue leyendo!";
          }
        }

        // --- COMPONENTE: LECCIÓN ACTIVA ---
        const ActiveLesson = ({ levelId, model, onBack }) => {
          const level = LEVELS.find(l => l.id === levelId);
          const items = level ? level.items : [];
          
          const [currentIndex, setCurrentIndex] = useState(0);
          const [isReading, setIsReading] = useState(false);
          
          const [highlightIndex, setHighlightIndex] = useState(-1);
          const [highlightType, setHighlightType] = useState(null); // 'SYLLABLE', 'WORD', 'FULL', null
          
          const [audioBlob, setAudioBlob] = useState(null);
          const [feedback, setFeedback] = useState(null);
          const [loadingFeedback, setLoadingFeedback] = useState(false);
          const [finished, setFinished] = useState(false);
          const [waitingForNext, setWaitingForNext] = useState(false);
          const [micError, setMicError] = useState(false);
          const [playbackRate, setPlaybackRate] = useState(1);

          const mediaRecorderRef = useRef(null);
          const chunksRef = useRef([]);
          const synthRef = useRef(window.speechSynthesis);
          const sequenceIdRef = useRef(0);

          const currentItem = items[currentIndex];

          useEffect(() => { return () => synthRef.current.cancel(); }, []);

          const startSession = async () => {
            if(isReading) return;
            setIsReading(true);
            setFinished(false);
            setFeedback(null);
            setAudioBlob(null);
            setMicError(false);
            setCurrentIndex(0);
            chunksRef.current = [];

            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              const recorder = new MediaRecorder(stream);
              mediaRecorderRef.current = recorder;
              recorder.ondataavailable = (e) => {
                if(e.data.size > 0) chunksRef.current.push(e.data);
              };
              recorder.onstop = () => {
                const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                setAudioBlob(blob);
                stream.getTracks().forEach(t => t.stop());
              };
              recorder.start();
            } catch (err) {
              setMicError(true);
            }
          };

          const handleNext = () => {
            synthRef.current.cancel();
            setWaitingForNext(false);
            setHighlightIndex(-1);
            setHighlightType(null);
            
            if (currentIndex < items.length - 1) {
              setCurrentIndex(prev => prev + 1);
            } else {
              finishSession();
            }
          };

          const handlePrev = () => {
            synthRef.current.cancel();
            setWaitingForNext(false);
            setHighlightIndex(-1);
            setHighlightType(null);
            if (currentIndex > 0) setCurrentIndex(prev => prev - 1);
          };

          const finishSession = () => {
            setIsReading(false);
            setFinished(true);
            setWaitingForNext(false);
            synthRef.current.cancel();
            if(mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
              mediaRecorderRef.current.stop();
            }
          };

          // --- LOGICA DE LECTURA (KARAOKE MEJORADO) ---
          const runSequence = useCallback(async () => {
            if (!currentItem) return;
            setWaitingForNext(false);
            sequenceIdRef.current++;
            const myId = sequenceIdRef.current;

            const speak = (txt, rate) => new Promise(resolve => {
              if (myId !== sequenceIdRef.current) return resolve();
              const u = new SpeechSynthesisUtterance(txt);
              u.lang = 'es-ES';
              u.rate = rate; 
              u.onend = resolve;
              u.onerror = resolve;
              synthRef.current.speak(u);
            });

            const wait = ms => new Promise(r => setTimeout(r, ms));

            await wait(500);
            if (myId !== sequenceIdRef.current) return;

            // --- MODO 1: SILÁBICO (Para TODOS los niveles si tienen sílabas definidas) ---
            if (model === ModelType.SYLLABIC) {
                // Prioridad a la propiedad 'syllables' (Niveles 1, 2, 3 y 4 ahora la tienen)
                if (currentItem.syllables) {
                   for (let i = 0; i < currentItem.syllables.length; i++) {
                      if (myId !== sequenceIdRef.current) return;
                      const syl = currentItem.syllables[i];
                      
                      // Si es un espacio, es una pausa entre palabras
                      if (syl === ' ') {
                          await wait(250); 
                          continue;
                      }

                      setHighlightIndex(i);
                      setHighlightType('SYLLABLE');
                      await speak(syl, 0.6); // Velocidad lenta para sílabas
                      await wait(150);
                   }
                   
                   // Al terminar las sílabas, lee la palabra/frase completa
                   if (myId !== sequenceIdRef.current) return;
                   setHighlightIndex(-1);
                   setHighlightType('FULL');
                   await speak(currentItem.text, 0.9);
                } 
                else {
                   // Fallback por si acaso
                   setHighlightType('FULL');
                   await speak(currentItem.text, 0.9);
                }
            }

            // --- MODO 2: FLUIDEZ ---
            else if (model === ModelType.FLUENCY) {
                // Si es una frase, resalta palabra por palabra
                if (currentItem.words) {
                    for (let i = 0; i < currentItem.words.length; i++) {
                        if (myId !== sequenceIdRef.current) return;
                        setHighlightIndex(i);
                        setHighlightType('WORD');
                        await speak(currentItem.words[i], playbackRate);
                        await wait(20); 
                    }
                }
                // Si es palabra suelta
                else {
                    setHighlightType('FULL');
                    await speak(currentItem.text, playbackRate);
                }
            }

            if (myId !== sequenceIdRef.current) return;
            setHighlightIndex(-1);
            setHighlightType(null); // Quitar resaltado al esperar
            setWaitingForNext(true); // Habilitar botón siguiente

          }, [currentItem, model, currentIndex, playbackRate]);

          // Trigger
          useEffect(() => {
            if (isReading && !finished) {
              runSequence();
            }
          }, [currentIndex, isReading, finished, runSequence]);

          const pedirFeedback = async () => {
            if(!audioBlob) return;
            setLoadingFeedback(true);
            const textoLeido = items.map(i => i.text).join(", ");
            const resp = await getTeacherFeedback(audioBlob, textoLeido);
            setFeedback(resp);
            setLoadingFeedback(false);
            const u = new SpeechSynthesisUtterance(resp);
            u.lang = 'es-ES';
            synthRef.current.speak(u);
          };

          const renderText = () => {
            if (!currentItem) return null;

            // MODO SILÁBICO (con Array de sílabas)
            if (model === ModelType.SYLLABIC && currentItem.syllables) {
              return (
                <div className="flex flex-wrap justify-center items-end gap-1 md:gap-2">
                  {currentItem.syllables.map((s, i) => {
                    // Renderizar espacio visual si la sílaba es ' '
                    if (s === ' ') {
                        return <div key={i} className="w-8 md:w-12 h-16 inline-block"></div>;
                    }

                    const isActive = (highlightType === 'SYLLABLE' && highlightIndex === i) || 
                                     (highlightType === 'FULL');
                    
                    return (
                      <span key={i} className={`text-6xl md:text-8xl font-bold transition-all duration-300 px-1 rounded-lg 
                        ${isActive ? 'text-kid-pink scale-110 bg-pink-100 shadow-lg' : 'text-gray-700'}`}>
                        {s}
                      </span>
                    );
                  })}
                </div>
              );
            }
            
            // MODO FLUIDEZ (con Array de palabras)
            if (currentItem.words) {
               return (
                <div className="flex flex-wrap justify-center gap-3">
                  {currentItem.words.map((w, i) => {
                    const isActive = (highlightType === 'WORD' && highlightIndex === i) || 
                                     (highlightType === 'FULL');

                    return (
                      <span key={i} className={`text-4xl md:text-6xl font-bold transition-all duration-200 px-2 rounded-lg
                        ${isActive ? 'text-kid-purple bg-purple-100 scale-110 shadow-lg' : 'text-gray-700'}`}>
                        {w}
                      </span>
                    );
                  })}
                </div>
               );
            }

            // MODO SIMPLE (Solo texto)
            return (
               <h2 className={`text-6xl md:text-8xl font-bold transition-all duration-300 
                  ${highlightType === 'FULL' ? 'text-kid-purple scale-110' : 'text-gray-700'}`}>
                  {currentItem.text}
               </h2>
            );
          };

          const isLast = currentIndex === items.length - 1;

          return (
            <div className="flex flex-col h-full max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden relative border-4 border-white">
              
              {/* Barra superior */}
              <div className={`p-4 flex flex-col md:flex-row items-center justify-between text-white ${level.color} gap-4`}>
                <div className="flex items-center gap-4 w-full md:w-auto">
                   <button onClick={onBack} className="bg-white/20 hover:bg-white/40 px-4 py-2 rounded-full font-bold btn-press">
                     🏠 Salir
                   </button>
                   <span className="text-xl font-bold uppercase tracking-wider hidden md:block">{model === ModelType.SYLLABIC ? '🐢 Silábico' : '🐇 Fluidez'}</span>
                </div>

                {/* SLIDER DE VELOCIDAD (SOLO FLUIDEZ) */}
                {model === ModelType.FLUENCY && (
                   <div className="flex items-center gap-2 bg-white/20 p-2 rounded-xl w-full md:w-64">
                      <span className="text-2xl">🐢</span>
                      <input 
                        type="range" 
                        min="0.5" 
                        max="1.5" 
                        step="0.1" 
                        value={playbackRate} 
                        onChange={(e) => setPlaybackRate(parseFloat(e.target.value))}
                        title="Velocidad de lectura"
                      />
                      <span className="text-2xl">🐇</span>
                   </div>
                )}
              </div>

              {/* Área principal */}
              <div className="flex-1 relative flex flex-col items-center justify-center p-4 bg-slate-50">
                
                {/* Progreso */}
                <div className="absolute top-0 left-0 h-2 bg-gray-200 w-full">
                  <div className="h-full bg-kid-green transition-all duration-500" style={{ width: `${((currentIndex + 1) / items.length) * 100}%` }}></div>
                </div>

                {/* Botones Flotantes de Navegación */}
                <div className="w-full flex justify-between items-center absolute px-2 md:px-8 top-1/2 -translate-y-1/2 z-0 pointer-events-none">
                   <button onClick={handlePrev} disabled={currentIndex === 0} 
                      className={`pointer-events-auto w-16 h-16 rounded-full bg-white shadow-xl flex items-center justify-center text-3xl hover:bg-blue-50 transition-all ${currentIndex===0 ? 'opacity-0' : 'opacity-100'}`}>
                      👈
                   </button>
                   
                   {/* Botón Siguiente (Flecha) */}
                   <button onClick={handleNext} 
                      /* Habilitado si NO estamos leyendo, O si estamos leyendo pero esperando confirmación */
                      disabled={isReading && !waitingForNext}
                      className={`pointer-events-auto w-20 h-20 rounded-full shadow-2xl flex items-center justify-center text-4xl transition-all border-4 
                      ${waitingForNext 
                         ? 'bg-kid-green text-white border-green-200 animate-bounce cursor-pointer opacity-100 scale-110' 
                         : 'bg-white text-gray-300 border-gray-100 opacity-50 cursor-not-allowed'}
                      ${(!isReading && !finished) ? 'opacity-20' : ''}
                      `}>
                      {isLast ? '🏁' : '👉'}
                   </button>
                </div>

                <div className="z-10 flex flex-col items-center gap-8 w-full max-w-2xl">
                   {currentItem.image && (
                     <div className="bg-white p-3 rounded-2xl shadow-lg transform -rotate-2 border-2 border-gray-100">
                        <img src={currentItem.image} className="h-48 md:h-64 object-contain rounded-lg" alt="imagen" />
                     </div>
                   )}
                   
                   <div className="text-center min-h-[120px] flex items-center justify-center w-full">
                      {renderText()}
                   </div>

                   {/* BOTÓN CENTRAL DE CONFIRMACIÓN */}
                   {waitingForNext && isReading && (
                     <button 
                        onClick={handleNext}
                        className="mt-6 bg-kid-green hover:bg-green-500 text-white text-3xl font-extrabold py-4 px-10 rounded-full shadow-[0_6px_0_0_#047857] hover:shadow-[0_3px_0_0_#047857] hover:translate-y-1 transition-all animate-bounce flex items-center gap-3 border-4 border-white z-50 pointer-events-auto"
                     >
                        ✅ ¡Terminé!
                     </button>
                   )}
                </div>
              </div>

              {/* Controles inferiores */}
              <div className="bg-white p-6 border-t flex flex-col items-center gap-4">
                {micError && isReading && (
                  <p className="text-red-500 text-sm font-bold bg-red-50 px-3 py-1 rounded-lg border border-red-200">
                    ⚠️ Micrófono bloqueado (modo lectura práctica).
                  </p>
                )}

                {!isReading && !finished && (
                  <button onClick={startSession} className="bg-kid-green hover:bg-green-400 text-white text-3xl font-extrabold py-4 px-12 rounded-full shadow-[0_6px_0_0_#05b586] btn-press transition-all flex gap-3 items-center">
                    ▶️ ¡COMENZAR!
                  </button>
                )}

                {isReading && (
                   <div className="flex flex-col items-center">
                     <span className="flex items-center gap-2 text-red-500 font-bold uppercase tracking-widest text-sm animate-pulse">
                       🔴 Grabando sesión
                     </span>
                     <button onClick={finishSession} className="text-gray-400 underline text-sm mt-2 hover:text-gray-600">
                       Detener lección
                     </button>
                   </div>
                )}

                {finished && (
                  <div className="flex flex-col items-center gap-4 w-full">
                    <h3 className="text-2xl font-bold text-kid-blue">🎉 ¡Lección Terminada! 🎉</h3>
                    
                    {audioBlob && (
                      <button 
                        onClick={() => {
                           const audio = new Audio(URL.createObjectURL(audioBlob));
                           audio.play();
                        }}
                        className="bg-blue-400 hover:bg-blue-500 text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg transition-all flex items-center gap-2"
                      >
                         🔊 Escuchar mi lectura
                      </button>
                    )}

                    {!feedback ? (
                       <button onClick={pedirFeedback} disabled={loadingFeedback} className="bg-kid-purple text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg hover:bg-purple-600 transition-all disabled:opacity-50">
                          {loadingFeedback ? '⏳ El Profe está escuchando...' : '✨ ¿Qué dice el Profe Mágico?'}
                       </button>
                    ) : (
                       <div className="bg-yellow-50 border-l-4 border-kid-yellow p-4 rounded text-left max-w-lg">
                          <p className="text-gray-600 font-bold mb-1">🤖 Profe IA:</p>
                          <p className="text-xl italic text-gray-800">"{feedback}"</p>
                       </div>
                    )}
                    
                    <button onClick={() => { setFinished(false); setCurrentIndex(0); setAudioBlob(null); setFeedback(null); }} className="text-gray-500 font-bold mt-2 hover:text-kid-blue">
                       🔄 Repetir Lección
                    </button>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // --- MENU PRINCIPAL ---
        const App = () => {
          const [level, setLevel] = useState(null);
          const [model, setModel] = useState(ModelType.SYLLABIC);

          if (level) {
             return (
               <div className="min-h-screen bg-blue-100 p-2 md:p-6 flex items-center justify-center">
                 <ActiveLesson levelId={level} model={model} onBack={() => setLevel(null)} />
               </div>
             )
          }

          return (
            <div className="min-h-screen bg-gradient-to-b from-cyan-50 to-blue-100 p-6 font-sans">
              <div className="max-w-5xl mx-auto">
                <header className="text-center py-10">
                  <h1 className="text-5xl md:text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-kid-blue to-kid-pink drop-shadow-sm mb-4">
                    Aprende a Leer
                  </h1>
                  <p className="text-xl text-gray-500 font-medium">¡Tu aventura mágica con las letras!</p>
                </header>

                <div className="flex justify-center mb-10">
                  <div className="bg-white p-2 rounded-full shadow-md inline-flex flex-wrap justify-center gap-2">
                    <button onClick={() => setModel(ModelType.SYLLABIC)} 
                      className={`px-6 py-3 rounded-full text-lg font-bold transition-all ${model === ModelType.SYLLABIC ? 'bg-kid-yellow text-gray-900 shadow-sm' : 'text-gray-400 hover:bg-gray-50'}`}>
                      🐢 Modo Silábico
                    </button>
                    <button onClick={() => setModel(ModelType.FLUENCY)} 
                      className={`px-6 py-3 rounded-full text-lg font-bold transition-all ${model === ModelType.FLUENCY ? 'bg-kid-green text-white shadow-sm' : 'text-gray-400 hover:bg-gray-50'}`}>
                      🐇 Modo Fluidez
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  {LEVELS.map(lvl => (
                    <button key={lvl.id} onClick={() => setLevel(lvl.id)}
                      className="group bg-white rounded-3xl p-6 shadow-xl hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 text-left border-b-8 border-gray-100 hover:border-kid-blue relative overflow-hidden">
                      <div className={`absolute top-0 right-0 w-24 h-24 rounded-bl-full opacity-20 ${lvl.color} transition-transform group-hover:scale-150`}></div>
                      <div className={`w-16 h-16 rounded-2xl ${lvl.color} flex items-center justify-center text-3xl shadow-inner mb-4`}>
                        {lvl.id === 'level-1' ? '🅰️' : lvl.id === 'level-2' ? '🗣️' : lvl.id === 'level-3' ? '📜' : lvl.id === 'level-4' ? '🎈' : lvl.id === 'level-5' ? '🦁' : lvl.id === 'level-6' ? '👪' : '📖'}
                      </div>
                      <h3 className="text-2xl font-bold text-gray-800 mb-2 leading-tight">{lvl.title}</h3>
                      <p className="text-sm text-gray-400 font-medium">{lvl.description}</p>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>